<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carmen AI - Advanced Training</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            /* üé® Theme Variables */
            --primary-color: #34558b;
            --primary-gradient: linear-gradient(135deg, #34558b 0%, #2a436b 100%);
            --secondary-bg: #f1f5f9;
            --bg-body: #f8fafc;
            --bg-card: #ffffff;

            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: #e2e8f0;

            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;

            --radius-md: 12px;
            --radius-lg: 20px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', 'Sarabun', sans-serif;
            margin: 0;
            padding: 30px;
            font-size: 14px;
        }

        /* --- Header --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: var(--bg-card);
            padding: 20px 30px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
        }

        .header h1 {
            margin: 0;
            color: var(--primary-color);
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn-back {
            background: white;
            border: 1px solid var(--border-color);
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            color: var(--text-muted);
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-back:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: #f8fafc;
            transform: translateX(-3px);
        }

        /* --- Layout --- */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 25px;
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 30px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.5);
            height: fit-content;
        }

        h2 {
            margin-top: 0;
            font-size: 18px;
            color: var(--text-main);
            margin-bottom: 20px;
            font-weight: 700;
        }

        /* --- Tabs (Pill Style) --- */
        .train-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 25px;
            background: #e2e8f0;
            padding: 5px;
            border-radius: 50px;
            width: fit-content;
            flex-wrap: wrap;
        }

        .t-btn {
            background: transparent;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 600;
            border-radius: 40px;
            transition: all 0.3s ease;
        }

        .t-btn:hover {
            color: var(--primary-color);
        }

        .t-btn.active {
            background: white;
            color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        /* --- Utility Classes --- */
        .flex-row {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .flex-1 {
            flex: 1;
        }

        .mt-24 {
            margin-top: 24px;
        }

        .p-10 {
            padding: 10px;
        }

        .mono-sm {
            font-size: 12px;
            color: #94a3b8;
            font-family: monospace;
        }

        .w-full {
            width: 100%;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .tab-panel {
            display: none;
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .tab-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Forms --- */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-main);
        }

        .input-box {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-family: inherit;
            font-size: 14px;
            transition: all 0.2s;
            background: #fff;
        }

        .input-box:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 85, 139, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: var(--text-main);
            cursor: pointer;
        }

        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary-color);
        }

        /* --- Action Buttons --- */
        .btn-train {
            width: 100%;
            padding: 14px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(52, 85, 139, 0.3);
            margin-top: 10px;
        }

        .btn-train:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 85, 139, 0.4);
        }

        .btn-train:active {
            transform: scale(0.98);
        }

        .btn-train:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* --- Console Card (Right Side) --- */
        .console-card {
            background: #0f172a;
            /* Dark Blue/Black */
            color: #e2e8f0;
            display: flex;
            flex-direction: column;
            border: 1px solid #1e293b;
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #334155;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 600;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #475569;
            transition: 0.3s;
        }

        .dot.active {
            background: #10b981;
            box-shadow: 0 0 10px #10b981;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.7;
                transform: scale(1.2);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .console-box {
            background: #1e293b;
            color: #10b981;
            /* Matrix Green */
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 8px;
            height: 350px;
            overflow-y: auto;
            font-size: 13px;
            border: 1px solid #334155;
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 20px;
        }

        .log-line {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 4px;
            word-wrap: break-word;
        }

        .console-box::-webkit-scrollbar {
            width: 6px;
        }

        .console-box::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }

        /* --- Progress Bar --- */
        .progress-container {
            margin-top: auto;
        }

        .progress-bar-bg {
            width: 100%;
            height: 10px;
            background: #334155;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            width: 0%;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 10px;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #94a3b8;
        }

        @media screen and (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }

            .console-box {
                height: 250px;
            }
        }
    </style>
</head>

<body>

    <div class="header">
        <h1>‚öôÔ∏è Carmen Data Engine</h1>
        <button class="btn-back" onclick="window.location.href='dashboard.html'">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
            Back to Dashboard
        </button>
    </div>

    <div class="container">
        <div class="card">
            <h2>üì• Select Data Source</h2>

            <div class="train-tabs">
                <button class="t-btn active" onclick="switchTab('file', event)">üìÑ File Upload</button>
                <button class="t-btn" onclick="switchTab('url', event)">üåê Website</button>
                <button class="t-btn" onclick="switchTab('repo', event)">üê± GitHub</button>
                <button class="t-btn" onclick="switchTab('manual', event)">‚úçÔ∏è Manual Text</button>
            </div>

            <div id="panel-file" class="tab-panel active">
                <div class="form-group">
                    <label for="ns-file">Target Business Unit (BU)</label>
                    <select id="ns-file" class="input-box namespace-select"
                        title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Business Unit ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå"></select>
                </div>
                <div class="form-group">
                    <label for="file-input">Select File (PDF, CSV, TXT, MD)</label>
                    <input type="file" id="file-input" class="input-box p-10"
                        title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏£‡∏ô (PDF, CSV, TXT, MD)">
                </div>
                <button class="btn-train" onclick="startFile()">üöÄ Upload & Train</button>
            </div>

            <div id="panel-url" class="tab-panel">
                <div class="form-group">
                    <label for="ns-url">Target Business Unit (BU)</label>
                    <select id="ns-url" class="input-box namespace-select"
                        title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Business Unit ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö URL"></select>
                </div>
                <div class="form-group">
                    <label for="url-input">Website URL</label>
                    <input type="text" id="url-input" class="input-box" placeholder="https://example.com/docs"
                        title="‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå">
                </div>
                <div class="form-group flex-row">
                    <div class="flex-1">
                        <label for="url-depth">Crawl Depth (Optional)</label>
                        <input type="number" id="url-depth" class="input-box" value="2" min="1" max="5"
                            title="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Crawl">
                    </div>
                    <div class="flex-1 mt-24">
                        <label class="checkbox-group">
                            <input type="checkbox" id="url-recursive" title="Crawl ‡πÅ‡∏ö‡∏ö Recursive">
                            Recursive Crawl
                        </label>
                    </div>
                </div>
                <button class="btn-train" onclick="startUrl()">üï∑Ô∏è Start Crawling</button>
            </div>

            <div id="panel-repo" class="tab-panel">
                <div class="form-group">
                    <label for="ns-repo">Target Business Unit (BU)</label>
                    <select id="ns-repo" class="input-box namespace-select"
                        title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Business Unit ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Repository"></select>
                </div>
                <div class="form-group">
                    <label for="repo-name">Repository (user/repo)</label>
                    <input type="text" id="repo-name" class="input-box" placeholder="carmen-org/backend-api"
                        title="‡∏ä‡∏∑‡πà‡∏≠ Repository">
                </div>
                <div class="form-group">
                    <label for="repo-token">Access Token (Optional for Private Repo)</label>
                    <input type="password" id="repo-token" class="input-box" placeholder="ghp_xxxxxxxxxxxx"
                        title="Github Access Token">
                </div>
                <div class="form-group">
                    <label class="checkbox-group">
                        <input type="checkbox" id="repo-incremental" title="‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞ commit ‡πÉ‡∏´‡∏°‡πà">
                        Incremental Update (Only new commits)
                    </label>
                </div>
                <button class="btn-train" onclick="startGithub()">üê± Clone & Learn</button>
            </div>

            <div id="panel-manual" class="tab-panel">
                <div class="form-group">
                    <label for="ns-text">Target Business Unit (BU)</label>
                    <select id="ns-text" class="input-box namespace-select"
                        title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Business Unit ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"></select>
                </div>
                <div class="form-group">
                    <label for="text-input">Text Content / Knowledge</label>
                    <textarea id="text-input" class="input-box" rows="10" placeholder="Paste internal knowledge here..."
                        title="‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ"></textarea>
                </div>
                <button class="btn-train" onclick="startText()">üíæ Save to Memory</button>
            </div>
        </div>

        <div class="card console-card">
            <div class="status-header">
                <div class="status-indicator">
                    <div id="status-dot" class="dot"></div>
                    <span id="status-text">System Idle</span>
                </div>
                <span id="timer" class="mono-sm">00:00</span>
            </div>

            <div id="console" class="console-box">
                <div class="log-line">[System] Ready to accept jobs...</div>
            </div>

            <div class="progress-container">
                <div class="progress-text">
                    <span id="progress-percent">0%</span>
                    <span id="progress-details">Processing...</span>
                </div>
                <div class="progress-bar-bg">
                    <div id="progress-fill" class="progress-bar-fill"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ‚úÖ 1. Auto-detect Backend API URL
        const API_BASE = (() => {
            const hostname = window.location.hostname;
            if (hostname === '127.0.0.1' || hostname === 'localhost') {
                return "http://127.0.0.1:8000";
            } else {
                return `${window.location.protocol}//${window.location.hostname}:8000`;
            }
        })();

        console.log("üîó Data Engine connected to:", API_BASE);

        let monitorInterval;
        let isRunning = false;
        let startTime;

        window.onload = async function () {
            await initNamespaces();
        };

        // --- Init Functions ---
        async function initNamespaces() {
            try {
                const res = await fetch(`${API_BASE}/api/admin/filters/bu`);
                const buList = await res.json();
                let optionsHTML = `<option value="global">üåê Global Knowledge</option>`;

                if (Array.isArray(buList)) {
                    buList.forEach(bu => {
                        if (bu && bu !== 'global') optionsHTML += `<option value="${bu}">${bu}</option>`;
                    });
                }

                document.querySelectorAll('.namespace-select').forEach(select => {
                    select.innerHTML = optionsHTML;
                });
            } catch (e) {
                console.warn("Failed to load BUs, using default.");
                document.querySelectorAll('.namespace-select').forEach(s => {
                    s.innerHTML = `<option value="global">üåê Global Knowledge</option>`;
                });
            }
        }

        function switchTab(tab, evt) {
            document.querySelectorAll('.tab-panel').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.t-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`panel-${tab}`).classList.add('active');
            if (evt) evt.target.classList.add('active');
        }

        // --- Action Functions ---

        async function startFile() {
            const file = document.getElementById('file-input').files[0];
            if (!file) return alert("Please select a file");

            const fd = new FormData();
            fd.append("file", file);
            fd.append("namespace", document.getElementById('ns-file').value);

            await sendRequest(`${API_BASE}/api/train/upload`, fd, true);
        }

        async function startText() {
            const payload = {
                text: document.getElementById('text-input').value,
                namespace: document.getElementById('ns-text').value,
                source: "manual-input"
            };
            if (!payload.text) return alert("Enter text");
            await sendRequest(`${API_BASE}/api/train`, JSON.stringify(payload));
        }

        async function startUrl() {
            // Backend expects just { "url": "..." }
            const urlVal = document.getElementById('url-input').value;
            if (!urlVal) return alert("Enter URL");

            const payload = {
                url: urlVal
            };

            await sendRequest(`${API_BASE}/api/train/url`, JSON.stringify(payload));
        }

        async function startGithub() {
            const payload = {
                repo_name: document.getElementById('repo-name').value,
                github_token: document.getElementById('repo-token').value,
                namespace: document.getElementById('ns-repo').value,
                incremental: document.getElementById('repo-incremental').checked
            };
            if (!payload.repo_name) return alert("Enter Repo Name");
            await sendRequest(`${API_BASE}/api/train/github`, JSON.stringify(payload));
        }

        // --- Helper & Monitor ---

        async function sendRequest(url, body, isFile = false) {
            const headers = {};
            if (!isFile) headers['Content-Type'] = 'application/json';

            // Disable buttons
            document.querySelectorAll('.btn-train').forEach(b => b.disabled = true);

            try {
                const res = await fetch(url, { method: 'POST', headers, body });
                const data = await res.json();

                if (res.ok) {
                    startMonitoring();
                } else {
                    alert(`‚ùå Error: ${data.detail || 'Unknown error'}`);
                    document.querySelectorAll('.btn-train').forEach(b => b.disabled = false);
                }
            } catch (e) {
                alert(`Network Error: ${e.message}`);
                document.querySelectorAll('.btn-train').forEach(b => b.disabled = false);
            }
        }

        function startMonitoring() {
            if (isRunning) return;
            isRunning = true;
            startTime = Date.now();

            document.getElementById('console').innerHTML = '<div class="log-line">[System] Job started...</div>';

            monitorInterval = setInterval(async () => {
                try {
                    const res = await fetch(`${API_BASE}/api/train/status`);
                    const state = await res.json();

                    updateUI(state);

                    // Update Timer
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
                    const secs = (elapsed % 60).toString().padStart(2, '0');
                    document.getElementById('timer').innerText = `${mins}:${secs}`;

                    // Check Finished
                    if (!state.is_running && state.progress >= 100) {
                        stopMonitoring(true);
                    } else if (!state.is_running && state.status.toLowerCase().includes("error")) {
                        stopMonitoring(false);
                    }
                } catch (e) { console.error("Monitor Error:", e); }
            }, 1000);
        }

        function stopMonitoring(success) {
            clearInterval(monitorInterval);
            isRunning = false;
            document.querySelectorAll('.btn-train').forEach(b => b.disabled = false);
            document.getElementById('status-dot').className = "dot";

            if (success) {
                document.getElementById('status-text').innerText = "Completed";
                alert("‚úÖ Job Completed Successfully!");
            } else {
                document.getElementById('status-text').innerText = "Failed";
                alert("‚ö†Ô∏è Job Failed or Interrupted.");
            }
        }

        function updateUI(state) {
            document.getElementById('status-text').innerText = state.status || "Running...";
            document.getElementById('status-dot').className = state.is_running ? "dot active" : "dot";

            const progress = state.progress || 0;
            document.getElementById('progress-fill').style.width = `${progress}%`;
            document.getElementById('progress-percent').innerText = `${progress}%`;

            // Console Logs
            const consoleBox = document.getElementById('console');
            if (state.logs && Array.isArray(state.logs) && state.logs.length > 0) {
                // Show last 50 logs only to prevent lag
                const logsToShow = state.logs.slice(-50);
                consoleBox.innerHTML = logsToShow.map(l => `<div class="log-line">${l}</div>`).join('');
                consoleBox.scrollTop = consoleBox.scrollHeight;
            }
        }
    </script>
</body>

</html>