<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carmen Trainer - ‡∏™‡∏≠‡∏ô‡∏ö‡∏≠‡∏ó</title>
    <style>
        body { font-family: 'Sarabun', sans-serif; max-width: 600px; margin: 40px auto; padding: 20px; background: #f3f4f6; }
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h2 { margin-top: 0; color: #111827; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #374151; }
        
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-family: inherit; margin-bottom: 20px; box-sizing: border-box; }
        textarea { height: 150px; resize: vertical; }
        
        button { background: #000; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; }
        button:hover { background: #2563eb; transform: translateY(-1px); }
        button.logout { background: #ef4444; margin-top: 10px; }
        
        .status { margin-top: 15px; padding: 10px; border-radius: 6px; display: none; text-align: center; font-size: 14px; }
        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #991b1b; }

        /* ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô Training ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô */
        #trainingSection { display: none; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>

    <div id="loginSection" class="card">
        <h2>üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Admin</h2>
        <label>Username:</label>
        <input type="text" id="loginUser" placeholder="admin">
        <label>Password:</label>
        <input type="password" id="loginPass" placeholder="password">
        <button onclick="doLogin()">Login</button>
        <div id="loginStatus" class="status"></div>
    </div>

    <div id="trainingSection" class="card">
        <h2>üë©‚Äçüè´ ‡∏™‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ Carmen</h2>
        <p style="color:#6b7280; font-size:14px; margin-bottom:20px;">
            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏°‡∏≠‡∏á (Pinecone) ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        </p>

        <label>‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà (Knowledge):</label>
        <textarea id="knowledgeInput" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ù‡πà‡∏≤‡∏¢‡πÑ‡∏≠‡∏ó‡∏µ‡∏Ñ‡∏∑‡∏≠ 02-xxx-xxxx"></textarea>

        <label>‡∏™‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÉ‡∏Ñ‡∏£‡∏£‡∏π‡πâ? (Namespace):</label>
        <select id="namespaceInput">
            <option value="">üåê ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (Global)</option>
            <option value="hotel-seaside">üèñÔ∏è ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Seaside</option>
            <option value="hotel-city">üèôÔ∏è ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ City</option>
        </select>

        <button onclick="sendData()" id="sendBtn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ üíæ</button>
        <button onclick="doLogout()" class="logout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        
        <div id="trainStatus" class="status"></div>
    </div>

    <script>
        const API_URL = "https://carmen-chatbot-api.onrender.com";
        let accessToken = localStorage.getItem('carmen_admin_token') || "";

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢ Login ‡πÑ‡∏ß‡πâ‡πÑ‡∏´‡∏°
        if (accessToken) {
            showTrainingSection();
        }

        async function doLogin() {
            const user = document.getElementById('loginUser').value;
            const pass = document.getElementById('loginPass').value;
            const status = document.getElementById('loginStatus');

            status.style.display = 'none';

            try {
                // ‡∏¢‡∏¥‡∏á‡πÑ‡∏õ‡∏Ç‡∏≠ Token
                const formData = new URLSearchParams();
                formData.append('username', user);
                formData.append('password', pass);

                const res = await fetch(`${API_URL}/token`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                if (res.ok) {
                    const data = await res.json();
                    accessToken = data.access_token;
                    localStorage.setItem('carmen_admin_token', accessToken); // ‡∏à‡∏≥‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
                    showTrainingSection();
                } else {
                    status.innerText = "‚ùå Username ‡∏´‡∏£‡∏∑‡∏≠ Password ‡∏ú‡∏¥‡∏î‡∏Ñ‡πà‡∏∞";
                    status.className = "status error";
                    status.style.display = 'block';
                }
            } catch (e) {
                alert("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Server ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + e.message);
            }
        }

        function showTrainingSection() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('trainingSection').style.display = 'block';
        }

        function doLogout() {
            accessToken = "";
            localStorage.removeItem('carmen_admin_token');
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('trainingSection').style.display = 'none';
            document.getElementById('loginUser').value = "";
            document.getElementById('loginPass').value = "";
        }

        async function sendData() {
            const text = document.getElementById('knowledgeInput').value.trim();
            const ns = document.getElementById('namespaceInput').value;
            const btn = document.getElementById('sendBtn');
            const status = document.getElementById('trainStatus');

            if (!text) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞!"); return; }

            btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
            btn.disabled = true;
            status.style.display = 'none';

            try {
                const res = await fetch(`${API_URL}/train`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}` // ‚úÖ ‡∏™‡πà‡∏á‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
                    },
                    body: JSON.stringify({ text: text, namespace: ns })
                });

                const data = await res.json();

                if (res.ok) {
                    status.className = "status success";
                    status.innerText = "‚úÖ " + data.message;
                    document.getElementById('knowledgeInput').value = ""; 
                } else {
                    if (res.status === 401) {
                        alert("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡πÉ‡∏´‡∏°‡πà");
                        doLogout();
                    } else {
                        status.className = "status error";
                        status.innerText = "‚ùå Error: " + (data.detail || "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                    }
                }
            } catch (err) {
                status.className = "status error";
                status.innerText = "‚ùå Connection Error: " + err.message;
            } finally {
                status.style.display = 'block';
                btn.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ üíæ";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>