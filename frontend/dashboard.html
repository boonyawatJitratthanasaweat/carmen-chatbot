<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carmen Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* üé® Carmen Chatbot Color Palette */
            --primary-color: #34558b;
            --primary-light: #eef2ff;
            --primary-gradient: linear-gradient(135deg, #34558b 0%, #2a436b 100%);
            
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            
            --text-main: #1e293b;
            --text-muted: #64748b;
            
            --border-color: #e2e8f0;
            --radius-md: 12px;
            --radius-lg: 18px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Inter', 'Sarabun', sans-serif; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° Sarabun */
            margin: 0;
            padding: 30px;
            font-size: 14px;
            line-height: 1.5;
        }

        /* --- Header --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: var(--bg-card);
            padding: 20px 30px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            flex-wrap: wrap;
            gap: 20px;
            border: 1px solid rgba(255,255,255,0.5);
        }

        .header h1 {
            margin: 0;
            color: var(--primary-color);
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* --- Inputs & Selects --- */
        select, input[type="text"] {
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-family: inherit;
            font-size: 14px;
            color: var(--text-main);
            background-color: #fff;
            transition: all 0.2s;
            outline: none;
        }

        select:focus, input[type="text"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 85, 139, 0.1);
        }

        /* --- Buttons --- */
        button, .btn-green, .btn-refresh {
            font-family: inherit;
            font-weight: 500;
            border: none;
            border-radius: 30px; /* Rounded Pill Style */
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            text-decoration: none;
            font-size: 13px;
            box-shadow: var(--shadow-sm);
        }

        button:active { transform: scale(0.97); }

        .btn-green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 10px 20px;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2);
        }
        .btn-green:hover { transform: translateY(-1px); box-shadow: 0 6px 15px rgba(16, 185, 129, 0.3); }

        .btn-refresh {
            background: white;
            color: var(--text-muted);
            border: 1px solid var(--border-color);
            padding: 9px 18px;
        }
        .btn-refresh:hover { 
            background: var(--bg-body); 
            color: var(--primary-color); 
            border-color: var(--primary-color);
        }

        /* --- Tabs --- */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 25px;
            padding: 6px;
            background: #e2e8f0; /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á Tab ‡∏£‡∏ß‡∏° */
            border-radius: 50px;
            width: fit-content;
            border: none;
        }

        .tab-btn {
            padding: 10px 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-muted);
            border-radius: 40px;
            transition: all 0.3s ease;
            box-shadow: none;
        }

        .tab-btn:hover { color: var(--primary-color); }

        .tab-btn.active {
            background: white;
            color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* --- Content Animation --- */
        .tab-content { display: none; }
        .tab-content.active { 
            display: block; 
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Table Card --- */
        .table-container {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden; /* Rounded corners for table */
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            min-width: 900px;
        }

        th {
            background: #f8fafc;
            padding: 16px 24px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
        }

        td {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-main);
            vertical-align: middle;
        }

        tr:last-child td { border-bottom: none; }
        
        tr:hover td {
            background-color: #f8fafc; /* Hover effect */
        }

        .cost {
            font-family: 'Inter', monospace;
            color: var(--primary-color);
            font-weight: 700;
            background: var(--primary-light);
            
            /* ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏•‡∏∞ Padding ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô */
            padding: 4px 10px;
            border-radius: 20px; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏°‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡πá‡∏î‡∏¢‡∏≤ (Pill) ‡∏à‡∏∞‡∏î‡∏π‡∏™‡∏ß‡∏¢‡∏Å‡∏ß‡πà‡∏≤ */
            font-size: 13px;
            
            /* ‚úÖ ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1; /* ‡∏ï‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ */
            vertical-align: middle; /* ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ß‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏∑‡πà‡∏ô */
            
            min-width: 80px; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡πÜ ‡∏Å‡∏±‡∏ô ‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö */
            box-shadow: inset 0 0 0 1px rgba(52, 85, 139, 0.1); /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏ö‡∏à‡∏≤‡∏á‡πÜ */
        }

        /* --- Knowledge Search Box --- */
        #tab-knowledge > div > div[style*="background: #f8fafc"] {
            background: white !important;
            box-shadow: var(--shadow-md);
            border-radius: var(--radius-lg) !important;
            padding: 24px !important;
            border: 1px solid var(--border-color) !important;
        }

        /* --- Modal --- */
        .modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.6); /* Backdrop ‡∏™‡∏µ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô */
            backdrop-filter: blur(4px);
            justify-content: center; align-items: center;
            z-index: 9999;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 24px;
            width: 90%; max-width: 600px; max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes modalSlideIn { from { opacity: 0; transform: scale(0.95) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        .model-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.2s;
            border-radius: 8px;
        }
        .model-item:hover { background: #f8fafc; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* --- Custom Alert Modal --- */
        .carmen-alert-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.6); /* ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏î‡∏≥‡∏à‡∏≤‡∏á‡πÜ */
            backdrop-filter: blur(4px); /* ‡πÄ‡∏ö‡∏•‡∏≠‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100000; /* ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î */
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .carmen-alert-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .carmen-alert-box {
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .carmen-alert-overlay.active .carmen-alert-box {
            transform: scale(1);
        }

        .carmen-alert-icon {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        .carmen-alert-message {
            font-size: 16px;
            color: var(--text-main);
            margin-bottom: 24px;
            line-height: 1.6;
            white-space: pre-line; /* ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà \n */
        }

        .carmen-alert-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(52, 85, 139, 0.4);
            transition: transform 0.1s;
        }

        .carmen-alert-btn:hover {
            transform: scale(1.05);
            background: #2a436b;
        }
        .carmen-alert-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>

<body>

    <div class="header">
        <h1>üìä Carmen Admin Dashboard</h1>

        <div class="controls">
            <select id="buFilter">
                <option value="all">üåê All Business Units</option>
            </select>

            <a href="train.html" class="btn-green"><span>+</span> Add Knowledge</a>
            <button class="btn-refresh" id="refreshBtn"><span>‚Üª</span> Refresh</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('logs')">üìã Logs</button>
        <button class="tab-btn" onclick="switchTab('analytics')">üìä Analytics</button>
        <button class="tab-btn" onclick="switchTab('knowledge')">üóÇÔ∏è Knowledge</button>
        <button class="tab-btn" onclick="switchTab('models')">‚öôÔ∏è Models</button>
    </div>

    <div id="tab-logs" class="tab-content active">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>BU</th>
                        <th>User Query</th>
                        <th>Model</th>
                        <th>Duration</th>
                        <th>Tokens (In/Out)</th>
                        <th>Cost</th>
                        <th>Sources</th>
                    </tr>
                </thead>
                <tbody id="logsBody"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-analytics" class="tab-content">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>BU</th>
                        <th>Requests</th>
                        <th>Total Tokens</th>
                        <th>Cost</th>
                    </tr>
                </thead>
                <tbody id="analyticsBody"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-knowledge" class="tab-content">
        <div style="margin-bottom: 30px;">
            <h3 style="margin-bottom: 15px; color: #334155;">üìä Vector Database Statistics</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Namespace</th>
                            <th>Vector Count</th>
                            <th>Ratio</th>
                        </tr>
                    </thead>
                    <tbody id="knowledgeBody"></tbody>
                </table>
            </div>
        </div>

        <hr style="border: 0; border-top: 1px solid #e2e8f0; margin: 30px 0;">

        <div>
            <h3 style="margin-bottom: 15px; color: #334155;">üîé Search Knowledge Base</h3>
            <div
                style="display: flex; gap: 10px; margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0;">
                <input type="text" id="kSearchQuery" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô '‡∏ß‡∏¥‡∏ò‡∏µ‡∏•‡∏≤‡∏á‡∏≤‡∏ô', '‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏á‡∏ö'..."
                    style="flex: 1; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; outline: none;">

                <select id="kSearchBU"
                    style="padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; width: 150px; cursor: pointer;">
                    <option value="global">üåê Global</option>
                </select>

                <button onclick="searchKnowledge()"
                    style="padding: 10px 25px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s;">
                    üîç Search
                </button>
            </div>

            <div class="table-container">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f1f5f9; text-align: left;">
                            <th style="width: 100px; padding: 12px;">Score</th>
                            <th style="width: 250px; padding: 12px;">Source File</th>
                            <th style="padding: 12px;">Content Snippet</th>
                        </tr>
                    </thead>
                    <tbody id="kResultsBody">
                        <tr>
                            <td colspan="3" style="text-align:center; padding: 30px; color:#94a3b8;">
                                ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° Search ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Database
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="tab-models" class="tab-content">
        <div style="margin-bottom:15px; display:flex; justify-content:space-between;">
            <h3>Active Models</h3>
            <button onclick="openModelModal()"
                style="background:#2563eb; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">Browse
                OpenRouter</button>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Model Name</th>
                        <th>Input Cost ($)</th>
                        <th>Output Cost ($)</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="modelsBody"></tbody>
            </table>
        </div>
    </div>

    <div id="orModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h2>OpenRouter Models</h2>
                <button onclick="document.getElementById('orModal').style.display='none'"
                    style="border:none; background:none; font-size:20px; cursor:pointer;">√ó</button>
            </div>
            <input type="text" id="orSearch" placeholder="Search..."
                style="width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; margin-bottom:10px;">
            <div id="orList">Loading...</div>
        </div>
    </div>

    <script type="module">
        import { AdminAPI } from '/static/admin-api.js?v=2';


        const api = new AdminAPI();
        const API_BASE_URL = "https://carmen-chatbot-api.onrender.com";
        let allORModels = [];
        let autoRefresh;

        // --- Init ---
        window.onload = () => {
            fetchData();
            // autoRefresh = setInterval(fetchData, 10000); // Auto refresh
        };

        // --- Core Functions ---
        async function fetchData() {
            const bu = document.getElementById('buFilter').value;
            const activeTabId = document.querySelector('.tab-content.active').id;

            try {
                if (activeTabId === 'tab-logs') {
                    const logs = await api.getLogs(bu);
                    renderLogs(logs);
                } else if (activeTabId === 'tab-analytics') {
                    const stats = await api.getAnalytics();
                    renderStats(stats);
                } else if (activeTabId === 'tab-knowledge') {
                    const res = await fetch('/knowledge/stats');
                    const vectors = await res.json();
                    renderKnowledge(vectors);
                } else if (activeTabId === 'tab-models') {
                    loadModels();
                }
            } catch (e) {
                console.error("Fetch Error:", e);
            }
        }

        function formatTableContent(text) {
            if (!text) return "";

            // ‡∏ï‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ö‡∏£‡∏¥‡∏ö‡∏ó)
            let formatted = text.substring(0, 300);

            // 1. ‡πÅ‡∏õ‡∏•‡∏á Markdown Image: ![alt](images/xxx) -> <img src="...">
            formatted = formatted.replace(/!\[(.*?)\]\s*\((.*?)\)/g, (match, alt, url) => {
                let cleanUrl = url.trim();
                if (cleanUrl.includes('images/') || cleanUrl.endsWith('.png') || cleanUrl.endsWith('.jpg')) {
                    cleanUrl = cleanUrl.replace(/^(\.\/|\/)/, '');
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å (Thumbnail) ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                    return `<br><img src="${API_BASE_URL}/${cleanUrl}" title="${alt}" style="max-height: 60px; width: auto; border-radius: 4px; border: 1px solid #e2e8f0; margin: 5px 0; cursor: pointer;" onclick="window.open(this.src, '_blank')"><br>`;
                }
                return match;
            });

            // 2. ‡πÅ‡∏õ‡∏•‡∏á HTML Image: <img src="images/xxx"> -> <img src="...">
            formatted = formatted.replace(/<img\s+[^>]*src=["'](.*?)["'][^>]*>/gi, (match, url) => {
                let cleanUrl = url.trim();
                // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô Path ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ http) ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏° Base URL
                if ((cleanUrl.includes('images/') || cleanUrl.endsWith('.png')) && !cleanUrl.startsWith('http')) {
                    cleanUrl = cleanUrl.replace(/^(\.\/|\/)/, '');
                    return `<br><img src="${API_BASE_URL}/${cleanUrl}" style="max-height: 60px; width: auto; border-radius: 4px; border: 1px solid #e2e8f0; margin: 5px 0; cursor: pointer;" onclick="window.open(this.src, '_blank')"><br>`;
                }
                return match;
            });

            return formatted + "...";
        }

        // --- Render Functions ---

        // 1. ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÑ‡∏ß‡πâ‡∏ô‡∏≠‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Logs ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        let currentLogsData = [];

        function renderLogs(logs) {
            const tbody = document.getElementById('logsBody');
            currentLogsData = logs || [];

            if (!logs || logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px; color:#94a3b8;">No logs found</td></tr>';
                return;
            }

            tbody.innerHTML = logs.map((log, i) => {
                let sourceBtn = '<span style="color:#cbd5e1;">-</span>';
                if (log.sources && log.sources.length > 0) {
                    sourceBtn = `<button onclick="showSources(${i})" style="background:#f1f5f9; border:1px solid #cbd5e1; color:#475569; cursor:pointer; padding:4px 8px; border-radius:4px; font-size:11px; transition:0.2s;">üìÑ View (${log.sources.length})</button>`;
                }

                return `
                    <tr>
                        <td>${new Date(log.timestamp).toLocaleTimeString()}</td>
                        <td><div style="display:flex; align-items:center;"><span style="background:#e0f2fe; color:#0284c7; padding:2px 8px; border-radius:6px; font-size:11px; font-weight:bold; border:1px solid #bae6fd;">${log.bu}</span><span style="font-size:12px; color:#475569; font-weight:500; display:flex; align-items:center; gap:3px;">
            üë§ ${log.username}
        </span></div></td>
                        <td style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size:13px;" title="${log.user_query}">${log.user_query || '-'}</td>
                        <td>${log.model_name}</td>
                        <td>${log.duration?.toFixed(2)}s</td>
                        <td>${log.total_tokens || 0}</td>
                        <td class="cost">$${(log.cost || 0).toFixed(6)}</td>
                        <td style="text-align:center;">${sourceBtn}</td>
                    </tr>`;
            }).join('');
        }


        function renderStats(stats) {
            const tbody = document.getElementById('analyticsBody');
            if (!stats || stats.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">No data available</td></tr>';
                return;
            }
            // ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderStats(stats)
            tbody.innerHTML = stats.map(st => `
     <tr>
        <td>
            <div style="display:flex; flex-direction:column; gap:2px;">
                <span style="font-weight:bold; color:#2563eb; font-size:14px;">
                    ${st.namespace.toUpperCase()}
                </span>
                
                <span style="font-size:11px; color:#64748b; display:flex; align-items:center; gap:4px;">
                    üë• ${st.user_count || 0} Users
                </span>
            </div>
        </td>
        <td>${st.total_requests.toLocaleString()}</td>
        <td>${st.total_tokens.toLocaleString()}</td>
        <td class="cost" style="font-size:15px;">$${st.total_cost.toFixed(6)}</td>
    </tr>`).join('');
        }

        function renderKnowledge(data) {
            const tbody = document.getElementById('knowledgeBody');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">No knowledge base found (Pinecone empty)</td></tr>';
                return;
            }
            tbody.innerHTML = data.map(item => `
                <tr>
                    <td style="font-weight:bold;">${item.namespace || 'Global'}</td>
                    <td>${item.count.toLocaleString()} vectors</td>
                    <td>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div style="flex:1; height:6px; background:#e2e8f0; border-radius:3px; overflow:hidden;">
                                <div style="width:${item.ratio}%; height:100%; background:#10b981;"></div>
                            </div>
                            <span style="font-size:12px; color:#64748b;">${item.ratio.toFixed(1)}%</span>
                        </div>
                    </td>
                </tr>`).join('');
        }

        async function searchKnowledge() {
            const query = document.getElementById('kSearchQuery').value.trim();
            const bu = document.getElementById('kSearchBU').value;
            const tbody = document.getElementById('kResultsBody');

            if (!query) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö"); return; }

            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px; color:#64748b;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>';

            try {
                const res = await fetch(`/knowledge/search?q=${encodeURIComponent(query)}&bu=${bu}&limit=10`);
                if (!res.ok) throw new Error("API Error");
                const results = await res.json();

                if (!results || results.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px; color:#ef4444;">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô</td></tr>';
                    return;
                }
                if (results.error) {
                    tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; padding:20px; color:red;">Error: ${results.error}</td></tr>`;
                    return;
                }

                tbody.innerHTML = results.map(item => `
                <tr style="border-bottom: 1px solid #f1f5f9; hover:background-color: #f8fafc;">
                    <td style="padding: 12px; vertical-align: top;">
                        <span style="background:${getScoreColor(item.score)}; color:white; padding:4px 8px; border-radius:6px; font-size:12px; font-weight:bold;">
                            ${(item.score * 100).toFixed(1)}%
                        </span>
                    </td>
                    <td style="padding: 12px; vertical-align: top;">
                        <div style="font-weight:600; color:#334155; font-size:13px;">üìÑ ${item.source}</div>
                        <div style="font-size:11px; color:#64748b; margin-top:4px;">Page ${item.page}</div>
                    </td>
                    <td style="padding: 12px; vertical-align: top; font-size:13px; color:#475569; line-height: 1.6;">
                        ${formatTableContent(item.content)}
                    </td>
                </tr>`).join('');
            } catch (err) {
                console.error(err);
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px; color:red;">‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</td></tr>';
            }
        }

        // --- Helpers ---
        function getScoreColor(score) {
            if (score >= 0.8) return '#16a34a';
            if (score >= 0.7) return '#ca8a04';
            return '#dc2626';
        }

        function showSources(index) {
            try {
                const log = currentLogsData[index];
                if (!log || !log.sources) {
                    alert("No sources found for this log.");
                    return;
                }
                const sources = log.sources;
                let msg = "üìö Reference Sources:\n-------------------\n";
                sources.forEach((s, i) => {
                    msg += `${i + 1}. üìÑ ${s.source} (Page ${s.page})\n`;
                    msg += `   üéØ Score: ${s.score}\n`;
                    let contentSnippet = s.content ? s.content.substring(0, 150) : "No content";
                    contentSnippet = contentSnippet.replace(/(\r\n|\n|\r)/gm, " ");
                    msg += `   üìù "${contentSnippet}..."\n\n`;
                });
                alert(msg);
            } catch (e) {
                console.error("Error displaying sources:", e);
                alert("Cannot display sources due to data error.");
            }
        }

        async function loadModels() {
            const models = await api.getLocalModels();
            const tbody = document.getElementById('modelsBody');
            tbody.innerHTML = models.map(m => `
                <tr style="${m.is_active ? 'background:#f0fdf4;' : ''}">
                    <td>${m.is_active ? '‚úÖ Active' : '‚ö™ Inactive'}</td>
                    <td style="font-weight:bold;">${m.model_name}</td>
                    <td>$${m.input_rate.toFixed(4)}</td>
                    <td>$${m.output_rate.toFixed(4)}</td>
                    <td>
                        ${!m.is_active ? `<button onclick="activateModel('${m.model_name}', ${m.input_rate}, ${m.output_rate})" style="cursor:pointer; color:#2563eb; border:1px solid #bfdbfe; background:white; padding:4px 8px; border-radius:4px;">Switch</button>` : '<span style="font-size:12px; color:#16a34a; font-weight:bold;">Current</span>'}
                        ${!m.is_active ? `<button onclick="deleteModel('${m.model_name}')" style="cursor:pointer; color:#ef4444; border:1px solid #fecaca; background:white; padding:4px 8px; border-radius:4px; margin-left:5px;">Del</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }


        async function loadBUOptions() {
            try {
                // 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API
                const res = await fetch(`${API_BASE_URL}/admin/filters/bu`);
                if (!res.ok) throw new Error("Failed to load BUs");
                const bus = await res.json();

                // ---------------------------------------------
                // A. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Dropdown ‡∏Å‡∏£‡∏≠‡∏á‡∏Å‡∏£‡∏≤‡∏ü (#buFilter)
                // ---------------------------------------------
                const filterSelect = document.getElementById('buFilter');
                if (filterSelect) {
                    const currentVal = filterSelect.value;
                    filterSelect.innerHTML = '<option value="all">üåê All Business Units</option>';

                    bus.forEach(bu => {
                        if (!bu || bu === 'global') return; // ‡∏Ç‡πâ‡∏≤‡∏° global ‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô (‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡∏£‡∏ß‡∏°‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå)
                        filterSelect.appendChild(createOption(bu));
                    });

                    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Global ‡πÑ‡∏ß‡πâ‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô DB ‡∏°‡∏µ global ‡∏Å‡πá‡∏à‡∏∞‡∏ñ‡∏π‡∏Å add ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)
                    // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ Global ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏¢‡∏Å‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏Å‡πá hardcode ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô HTML ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ

                    if (currentVal && currentVal !== 'all') filterSelect.value = currentVal;
                }

                // ---------------------------------------------
                // B. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Dropdown ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ (#kSearchBU) ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                // ---------------------------------------------
                const searchSelect = document.getElementById('kSearchBU');
                if (searchSelect) {
                    const currentVal = searchSelect.value;
                    // Default ‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏∑‡∏≠ Global
                    searchSelect.innerHTML = '<option value="global">üåê Global</option>';

                    bus.forEach(bu => {
                        // ‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤ global ‡∏ã‡πâ‡∏≥ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ Default ‡πÅ‡∏•‡πâ‡∏ß
                        if (!bu || bu === 'global') return;
                        searchSelect.appendChild(createOption(bu));
                    });

                    if (currentVal && currentVal !== 'global') searchSelect.value = currentVal;
                }

            } catch (e) {
                console.error("Error loading BU options:", e);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á <option> ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô (‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ã‡πâ‡∏≥)
        function createOption(bu) {
            const option = document.createElement('option');
            option.value = bu;

            let icon = "üè¢";
            const upperBU = bu.toUpperCase();
            if (upperBU.includes("HR")) icon = "üë•";
            else if (upperBU.includes("ACCOUNT") || upperBU.includes("SALES")) icon = "üí∞";
            else if (upperBU.includes("HOTEL")) icon = "üè®";
            else if (upperBU.includes("IT") || upperBU.includes("DEV")) icon = "üíª";

            option.textContent = `${icon} ${bu}`;
            return option;
        }
        window.onload = async () => {
            await loadBUOptions(); // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å BU ‡∏Å‡πà‡∏≠‡∏ô
            fetchData();           // ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏≤‡∏ü
            // autoRefresh = setInterval(fetchData, 10000); 
        };

        // --- Custom Alert Logic (Override window.alert) ---
        function initCustomAlert() {
            // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏Ç‡∏≠‡∏á Alert ‡∏£‡∏≠‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Body
            const alertHTML = `
                <div id="carmenAlertOverlay" class="carmen-alert-overlay">
                    <div class="carmen-alert-box">
                        <div class="carmen-alert-icon">üí°</div>
                        <div id="carmenAlertMsg" class="carmen-alert-message"></div>
                        <button class="carmen-alert-btn" onclick="closeCarmenAlert()">‡∏ï‡∏Å‡∏•‡∏á</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', alertHTML);

            // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î Alert (Expose to window)
            window.closeCarmenAlert = () => {
                const overlay = document.getElementById('carmenAlertOverlay');
                overlay.classList.remove('active');
            };

            // 3. üí• Override ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á alert() ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á Browser
            window.alert = (message) => {
                const overlay = document.getElementById('carmenAlertOverlay');
                const msgBox = document.getElementById('carmenAlertMsg');
                const iconBox = document.querySelector('.carmen-alert-icon');
                
                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ (‡∏•‡∏π‡∏Å‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)
                if (message.includes("Error") || message.includes("‡πÑ‡∏°‡πà‡∏û‡∏ö")) iconBox.textContent = "‚ùå";
                else if (message.includes("Success") || message.includes("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")) iconBox.textContent = "‚úÖ";
                else iconBox.textContent = "üí°";

                msgBox.textContent = message; // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                overlay.classList.add('active'); // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            };
        }

        // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        initCustomAlert();

        window.showSources = showSources;
        window.searchKnowledge = searchKnowledge;
        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            if (event && event.target) event.target.classList.add('active');
            fetchData();
        };

        document.getElementById('refreshBtn').onclick = fetchData;
        document.getElementById('buFilter').onchange = fetchData;
        document.getElementById('kSearchQuery').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') searchKnowledge();
        });



        window.activateModel = async (id, inp, out) => { if (confirm('Switch to ' + id + '?')) { await api.activateModel(id, inp, out); loadModels(); } };
        window.deleteModel = async (id) => { if (confirm('Delete ' + id + '?')) { await api.deleteModel(id); loadModels(); } };
        window.openModelModal = async () => { document.getElementById('orModal').style.display = 'flex'; allORModels = await api.getOpenRouterModels(); renderORList(allORModels); };
        window.renderORList = (list) => { document.getElementById('orList').innerHTML = list.map(m => `<div class="model-item"><div><b>${m.name}</b><br><span style="font-size:11px; color:#666;">${m.id}</span></div><button onclick="addFromOR('${m.id}', ${m.input_rate}, ${m.output_rate})" style="border:1px solid #2563eb; color:#2563eb; background:white; padding:4px 10px; border-radius:4px; cursor:pointer;">Add</button></div>`).join(''); };
        window.filterModels = () => { const q = document.getElementById('orSearch').value.toLowerCase(); renderORList(allORModels.filter(m => m.name.toLowerCase().includes(q) || m.id.toLowerCase().includes(q))); };
        document.getElementById('orSearch').onkeyup = window.filterModels;
        window.addFromOR = async (id, inp, out) => { if (confirm(`Add ${id}?`)) { await api.addModel(id, inp, out); await api.activateModel(id, inp, out); document.getElementById('orModal').style.display = 'none'; loadModels(); } };



    </script>
</body>

</html>